<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <title>무장애 IN 성동구</title>

</head>

<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="/__/firebase/7.23.0/firebase-app.js"></script>
    <script src="/__/firebase/7.23.0/firebase-analytics.js"></script>
    <script src="/__/firebase/7.23.0/firebase-auth.js"></script>
    <script src="/__/firebase/7.23.0/firebase-firestore.js"></script>
    <script src="/__/firebase/7.23.0/firebase-storage.js"></script>
    <script src="/__/firebase/init.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <script src="https://cdn.klokantech.com/maptilerlayer/v1/index.js"></script>

    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps-geocoder.js"></script>

    <style>
        body {
            margin: 20px;
        }

        .dropdown-submenu {
            position: relative;
        }

        .dropdown-submenu .dropdown-menu {
            top: 0;
            left: 100%;
            margin-top: -1px;
        }
        .top_title_layout{
            margin-right: 10px;
        }
        

        
    </style>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a id="firest_tab" class="nav-link active" data-toggle="tab" href="#mapContent">장소</a>
        </li>
        <li class="nav-item">
            <a id="second_tab" class="nav-link" data-toggle="tab" href="#noticeContent">공지사항</a>
        </li>
        <li class="nav-item">
            <a id="third_tab" class="nav-link" data-toggle="tab" href="#feedbackContent">의견</a>
        </li>
        <li>
            <a id="login_id"></a>
        </li>
        <li class="nav-item">
            <button id="logout" type="button" class="btn btn-toolbar" data-toggle="modal"
                href="#dialog_logout">로그아웃</button>
        </li>

    </ul>
    <script>
        $( document ).ready( function () {

            $( '#firest_tab' ).click();
            $( '#firest_tab' ).on( "click", function ( e ) {
                $( '#mapContent' ).show();
                $( '#noticeContent' ).hide();
                $( '#feedbackContent' ).hide();
            } );
            $( '#second_tab' ).on( "click", function ( e ) {
                $( '#mapContent' ).hide();
                $( '#noticeContent' ).show();
                $( '#feedbackContent' ).hide();
            } );
            $( '#third_tab' ).on( "click", function ( e ) {
                console.log( "third tah clicked" );
                $( '#mapContent' ).hide();
                $( '#noticeContent' ).hide();
                $( '#feedbackContent' ).show();
            } );
            $( '#logout_ok' ).on( "click", function ( e ) {
                firebase.auth().signOut().then( function () {
                    console.log( "logout success" );
                } ).catch( function ( error ) {
                    console.error( error );
                } );
            } );
            $( '#logout_cancel' ).on( "click", function ( e ) {
                $( '#dialog_logout' ).hide();
            } );


        } );
    </script>

    <!-- logout permission dialog-->
    <div class="modal fade" id="dialog_permission" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <p>권한없음</p>
                </div>
                <div class="modal-body">
                    <p>해당 계정은 권한이 없습니다. tothetg@naver.com로 문의하시기 바랍니다.</p>
                </div>
                <div class="modal-footer">
                    <button id="permission_ok" type="button" class="btn btn-success" data-dismiss="modal">확인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- logout dialog-->
    <div class="modal fade" id="dialog_logout" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <p>로그아웃</p>
                </div>
                <div class="modal-body">
                    <p>로그아웃 하시겠습니까?</p>
                </div>
                <div class="modal-footer">
                    <button id="logout_ok" type="button" class="btn btn-success" data-dismiss="modal">예</button>
                    <button id="logout_cancel" type="button" class="btn btn-warning" data-dismiss="modal">아니오</button>
                </div>
            </div>
        </div>
    </div>
    <!-- delete category dialog-->
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="categoryModalLabel">카테고리 삭제</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  <label id="category_delete_text" for="message-text" class="col-form-label">카테고리 삭제</label>
                  
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
              <button id="category_delete_ok_btn" type="button" class="btn btn-primary" data-dismiss="modal">삭제</button>
            </div>
          </div>
        </div>
    </div>

    <!-- delete subcategory dialog-->
    <div class="modal fade" id="deleteSubCategoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="categoryModalLabel">카테고리 삭제</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  <label id="sub_category_delete_text" for="message-text" class="col-form-label">카테고리 삭제</label>
                  
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
              <button id="sub_category_delete_ok_btn" type="button" class="btn btn-primary" data-dismiss="modal">삭제</button>
            </div>
          </div>
        </div>
    </div>

    <!-- add category dialog-->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="categoryModalLabel">카테고리 추가</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  <label for="message-text" class="col-form-label">카테고리</label>
                  <textarea id="category_add_text" class="form-control" id="message-text"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
              <button id="category_add_btn" type="button" class="btn btn-primary" data-dismiss="modal">추가</button>
            </div>
          </div>
        </div>
      </div>
    <br>
    <!-- add sub category dialog-->
    <div class="modal fade" id="subCategoryModal" tabindex="-1" role="dialog" aria-labelledby="subCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="subCategoryModalLabel">상세 카테고리 추가</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group">
                  <label for="message-text" class="col-form-label">상세 카테고리</label>
                  <textarea id="subCategory_add_text" class="form-control" id="message-text"></textarea>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
              <button id="subCategory_add_btn" type="button" class="btn btn-primary" data-dismiss="modal">추가</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="mapContent">
        <!-- top dropdown-->
            
        <div class="row">
            <div class=" col-lg-4">
                <span style="font-size:2em" id="category">카테고리</span>
                <br>
                <!--<button type='button' class='btn btn-light' data-toggle='modal' data-target='#modifyCategoryModal'>수정</button>-->
                <button id="category_delete_btn" type='button' class='btn btn-light' data-toggle='modal' data-target='#deleteCategoryModal'>삭제</button>
            </div>
            <div class=" col-lg-4">
                <span style="font-size:2em" id="subCategory"></span>
                <br>
                <!--<button type='button' class='btn btn-light' data-toggle='modal' data-target='#modifyCategoryModal'>수정</button>-->
                <button id="sub_category_delete_btn" type='button' class='btn btn-light' data-toggle='modal' data-target='#deleteSubCategoryModal'>삭제</button>
            </div>
            <div class=" col-lg-4">
                <span style="font-size:2em" id="count">개</span>
            </div>
        </div>
           
        </div>
        <br>
        <div class="row">
            
            <div style="left: 16px;" class="dropdown">
                <button id="dropdown_btn" class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택
                    <span class="caret"></span></button>
                <ul class="dropdown-menu" id="category_dropdown">
                    <!-- by initDropdown -->
                </ul>
            </div>
            <br>
            <div class=" col-lg-4">

                <input id="search_address" type="search" class="form-control" placeholder="검색할 주소" value="" />
                <button id="search_submit" type="button" value="주소 검색" class="btn btn-light">주소 검색</button>
                <button id="search_reset" type="button" value="초기화" class="btn btn-dark">초기화</button>
            </div>
            <div class=" col-lg-4">
                <input id="search_address_place" type="search" class="form-control" placeholder="검색할 장소" value="" />
                <button id="search_submit_place" type="button" value="장소 검색" class="btn btn-light">장소 검색</button>
            </div>
        </div>
        <br>
        <button id="map_refresh" type="button" class="btn btn-success" data-toggle="modal">지도 업데이트</button>
        <br>
        <!-- map -->
        <!-- <div id="map" style="width:100%; height: 100vh;"></div> -->
        <div id="map_naver" style="width:100%;height:100vh;"></div>
        <script type="text/javascript"
            src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=quld7x8r88&callback=initNaverMap&submodules=geocoder"></script>
        <br>
        <img src="http://maps.google.com/mapfiles/ms/micons/blue.png">모바일 표시 지역
        <img src="http://maps.google.com/mapfiles/ms/micons/red.png">테스트 지역(모바일에 표시되지 않음)
        <img src="http://maps.google.com/mapfiles/ms/icons/green.png">현재 선택 지역
        <br>
        <!-- input -->

        <div class="col-sm-12 pt-3">
            <div class="card">
                <div class="card-header card-header-primary">
                    <h4 class="card-title"><i class="fas fa-square"></i>장소 추가</h4>
                    <p class="card-catagory"></p>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td>카테고리</td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button"
                                                data-toggle="dropdown">선택
                                                <span class="caret"></span></button>
                                            <ul class="dropdown-menu" id="category_dropdown_data">

                                            </ul>
                                        </div>

                                    </td>
                                    <td>카테고리1(필수)</td>
                                    <td>
                                        <input id="input_category1" type="text" name="category1" class="form-control"
                                            value="" readonly>
                                    </td>
                                    <td>카테고리2(필수)</td>
                                    <td>
                                        <input id="input_category2" type="text" name="category2" class="form-control"
                                            value="" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <td>이름(필수)</td>
                                    <td>
                                        <input id="name" type="text" name="name" class="form-control" maxlength="20"
                                            value="">
                                    </td>
                                    <td>연락처</td>
                                    <td>
                                        <input id="contact" type="text" name="contact" class="form-control"
                                            maxlength="20" value="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>경도(필수)</td>
                                    <td>
                                        <input id="latitude" type="text" name="latitude" class="form-control" value="">
                                    </td>
                                    <td>위도(필수)</td>
                                    <td>
                                        <input id="longitude" type="text" name="longitude" class="form-control"
                                            value="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>주소</td>
                                    <td>
                                        <input id="address" type="text" name="address" class="form-control" value="">
                                    </td>
                                    <td>층</td>
                                    <td>
                                        <input id="input_floor" type="text" name="floor" class="form-control" value=""
                                            readonly>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button"
                                                data-toggle="dropdown">선택
                                                <span class="caret"></span></button>
                                            <ul id="floor" class="dropdown-menu">
                                                <li><a tabindex="-1" href="#">1층</a></li>
                                                <li><a tabindex="-1" href="#">2층</a></li>
                                                <li><a tabindex="-1" href="#">3층</a></li>
                                                <li><a tabindex="-1" href="#">4층</a></li>
                                                <li><a tabindex="-1" href="#">5층</a></li>
                                                <li><a tabindex="-1" href="#">6층</a></li>
                                                <li><a tabindex="-1" href="#">7층</a></li>
                                                <li><a tabindex="-1" href="#">8층</a></li>
                                                <li><a tabindex="-1" href="#">9층</a></li>
                                                <li><a tabindex="-1" href="#">10층</a></li>
                                                <li><a tabindex="-1" href="#">지하1층</a></li>
                                                <li><a tabindex="-1" href="#">지하2층</a></li>
                                                <li><a tabindex="-1" href="#">지하3층</a></li>
                                                <li><a tabindex="-1" href="#">지하4층</a></li>
                                                <li><a tabindex="-1" href="#">지하5층</a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>설명</td>
                                    <td>
                                        <input id="summary" type="text" name="summary" class="form-control" value="">
                                    </td>
                                    <!-- <td>사용여부</td>
                                    <td>
                                        <input id="input_using" type="text" name="using" class="form-control" value="" readonly>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">선택
                                            <span class="caret"></span></button>
                                            <ul id="using" class="dropdown-menu">
                                                <li><a tabindex="-1" href="#" value="true">예</a></li>
                                                <li><a tabindex="-1" href="#" value="false">아니오</a></li>
                                            </ul>
                                        </div>
                                    </td> -->
                                </tr>
                                <!--
                                <tr>
                                    <td>기본 이미지</td>
                                    <td>
                                        <input type="file" id="image1" value="">
                                    </td>
                                    <td>
                                        <button id="image1_reset">초기화</button>
                                    </td>
                                    <td>
                                        <img id="image1_preview" src="">
                                    </td>
                                </tr>
                                -->
                                <tr>
                                    <td>경사로 이미지</td>
                                    <td>
                                        <input type="file" id="image2" value="">
                                    </td>
                                    <td>
                                        <button id="image2_reset">초기화</button>
                                    </td>
                                    <td>
                                        <img id="image2_preview" src="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>주차장 이미지</td>
                                    <td>
                                        <input type="file" id="image3" value="">
                                    </td>
                                    <td>
                                        <button id="image3_reset">초기화</button>
                                    </td>
                                    <td>
                                        <img id="image3_preview" src="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>화장실 이미지</td>
                                    <td>
                                        <input type="file" id="image4" value="">
                                    </td>
                                    <td>
                                        <button id="image4_reset">초기화</button>
                                    </td>
                                    <td>
                                        <img id="image4_preview" src="">
                                    </td>
                                </tr>
                                <tr>
                                    <td>엘리베이터 이미지</td>
                                    <td>
                                        <input type="file" id="image5" value="">
                                    </td>
                                    <td>
                                        <button id="image5_reset">초기화</button>
                                    </td>
                                    <td>
                                        <img id="image5_preview" src="">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="text-center mt-3">
            <button id="submit" type="button" class="btn btn-success" data-toggle="modal">추가</button>
            <button id="reset" type="button" class="btn btn-warning">초기화</button>
            <button id="delete" type="button" class="btn btn" data-toggle="modal" aria-hidden="true"
                href="#dialog_delete">삭제</button>
        </div>

        <!-- complete dialog-->
        <div class="modal fade" id="dialog_complete" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>장소 추가/수정</p>
                    </div>
                    <div class="modal-body">
                        <p>완료되었습니다.</p>
                    </div>
                    <div class="modal-footer">
                        <button id="complete_ok" type="button" class="btn btn-success" data-dismiss="modal">확인</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- delete dialog-->
        <div class="modal fade" id="dialog_delete" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>장소 삭제</p>
                    </div>
                    <div class="modal-body">
                        <p>삭제하시겠습니까?</p>
                    </div>
                    <div class="modal-footer">
                        <button id="delete_ok" type="button" class="btn btn-success" data-dismiss="modal">예</button>
                        <button id="delete_cancel" type="button" class="btn btn-warning"
                            data-dismiss="modal">아니오</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- input dialog-->
        <div class="modal fade" id="dialog_submit" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>장소 추가</p>
                    </div>
                    <div class="modal-body">
                        <p>장소를 추가(수정)하시겠습니까?</p>
                    </div>
                    <div class="modal-footer">
                        <button id="submit_ok" type="button" class="btn btn-success" data-dismiss="modal">예</button>
                        <button id="submit_cancel" type="button" class="btn btn-warning"
                            data-dismiss="modal">아니오</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- input error dialog-->
        <div class="modal fade" id="dialog_error" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>데이터 오류</p>
                    </div>
                    <div class="modal-body">
                        <p>필수 데이터 입력을 확인하세요.(좌표는 숫자이어야 합니다.)</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" data-dismiss="modal">확인</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABmYv4KCOQfOSt3b6ViE2bvtZ_CYBx9mA&callback=initMap&region=kr"></script> -->
        <script>
            var db;
            var map;
            var markers = [];
            var infowindows = [];
            var markers_hash = {};
            var infowindows_hash = {};
            var map = null;
            var list = [];

            function initNaverMap() {
                console.log( "initNaverMap" );
                var mapOptions = {
                    scaleControl: false,
                    logoControl: false,
                    mapDataControl: false,
                    zoomControl: true,
                    center: new naver.maps.LatLng( 37.5554457018368, 127.03594955605 ),
                    zoom: 16
                };
                map = new naver.maps.Map( 'map_naver', mapOptions );
                naver.maps.Event.addListener( map, "click", function ( e ) {
                    resetAll();
                    $( "#latitude" ).val( e.coord.y );
                    $( "#longitude" ).val( e.coord.x );
                    $( "#delete" ).hide();
                    addTempNaverMarker( e.coord.y, e.coord.x, map );
                } );
                initFirebase( map );
            }


            // init map
            function initMap() {
                console.log( "initMap" );
                var center = {
                    lat: 37.5554457018368,
                    lng: 127.03594955605
                };
                map = new google.maps.Map(
                    document.getElementById( 'map' ), {
                    zoom: 16,
                    center: center
                } );
                var geoloccontrol = new klokantech.GeolocationControl( map, 16 );
                map.addListener( "click", ( e ) => {
                    resetAll();
                    $( "#latitude" ).val( e.latLng.lat );
                    $( "#longitude" ).val( e.latLng.lng );
                    $( "#delete" ).hide();
                    addTempMarker( e.latLng );

                } );
                initFirebase( map );

            }

            function resetAll() {
                console.log( "resetAll" );
                $( "#submit" ).val( "" );
                $( "#submit" ).text( "추가" );
                $( "#data_category1" ).val( "" );
                $( "#data_category2" ).val( "" );

                $( '#input_category1' ).val( "" );
                $( '#input_category2' ).val( "" );

                $( '#latitude' ).val( "" );
                $( '#longitude' ).val( "" );
                $( '#name' ).val( "" );
                $( '#contact' ).val( "" );
                $( '#address' ).val( "" );
                $( '#summary' ).val( "" );
                $( '#input_floor' ).val( "" );
                $( '#input_using' ).val( "" );


                $( "#image1" ).val( "" );
                $( "#image1_reset" ).val( "" );
                $( "#image1_preview" ).attr( 'src', "" );
                $( "#image2" ).val( "" );
                $( "#image2_reset" ).val( "" );
                $( "#image2_preview" ).attr( 'src', "" );
                $( "#image3" ).val( "" );
                $( "#image3_reset" ).val( "" );
                $( "#image3_preview" ).attr( 'src', "" );
                $( "#image4" ).val( "" );
                $( "#image4_reset" ).val( "" );
                $( "#image4_preview" ).attr( 'src', "" );
                $( "#image5" ).val( "" );
                $( "#image5_reset" ).val( "" );
                $( "#image5_preview" ).attr( 'src', "" );


            }

            var tempMarker;

            function addTempNaverMarker( x, y, map ) {
                console.log( "addTempNaverMarker coord :" + x + " " + y );
                if ( tempMarker != null ) {
                    tempMarker.setMap( null );
                }
                for ( var i = 0; i < infowindows.length; i++ ) {
                    infowindows[i].close();
                }


                var markerOptions = {
                    position: new naver.maps.LatLng( x, y ),
                    map: map,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/green.png',
                        size: new naver.maps.Size( 50, 52 ),
                        origin: new naver.maps.Point( 0, 0 ),
                        anchor: new naver.maps.Point( 25, 26 )
                    }
                };

                tempMarker = new naver.maps.Marker( markerOptions );

                var title = y + " , " + x;
                var infowindow = new naver.maps.InfoWindow( {
                    content: title
                } );

                naver.maps.Event.addListener( tempMarker, "click", function ( e ) {
                    if ( infowindow.getMap() ) {
                        infowindow.close();
                    } else {
                        infowindow.open( map, tempMarker );
                    }
                } );
                infowindows.push( infowindow );
            }

            function addTempMarker( latLng ) {
                if ( tempMarker != null ) {
                    tempMarker.setMap( null );
                }

                tempMarker = new google.maps.Marker( {
                    position: latLng,
                    map: map,
                    label: latLng.toString(),
                } );
                tempMarker.setIcon( 'http://maps.google.com/mapfiles/ms/icons/green.png' );

                const infowindow = new google.maps.InfoWindow( {
                    content: latLng.toString()
                } );
                tempMarker.addListener( "click", () => {
                    infowindow.open( map, tempMarker );
                } );

            }
            // init firebase
            function initFirebase( map ) {
                var firebaseConfig = {
                    apiKey: "AIzaSyABmYv4KCOQfOSt3b6ViE2bvtZ_CYBx9mA",
                    authDomain: "nodisable.firebaseapp.com",
                    databaseURL: "https://nodisable.firebaseio.com",
                    projectId: "nodisable",
                    storageBucket: "nodisable.appspot.com",
                    messagingSenderId: "518286416974",
                    appId: "1:518286416974:web:3e85423664dc7887a2371f",
                    measurementId: "G-66LMB3ZB9N"
                };


                //firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                initAuth( firebase, db );
                updateList( "", "전체", "전체" );
                //initData(firebase, db, map, "", "");
                initDropdown(firebase,db);
                initInputDropDown(firebase,db);
                initSearch( map );

            }
            function initSearch( map ) {
                // address earch

                $( '#search_submit' ).on( 'click', function ( e ) {
                    e.preventDefault();
                    searchAddressToCoordinate( map, $( '#search_address' ).val() );

                } );
                $( '#search_reset' ).on( 'click', function ( e ) {
                    e.preventDefault();
                    if ( tempMarker != null ) {
                        tempMarker.setMap( null );
                    }
                    for ( var i = 0; i < infowindows.length; i++ ) {
                        infowindows[i].close();
                    }

                } );

                $( '#search_submit_place' ).on( 'click', function ( e ) {
                    e.preventDefault();
                    for ( var i = 0; i < infowindows.length; i++ ) {
                        infowindows[i].close();
                    }
                    resetAll();
                    searchPlace( map, $( '#search_address_place' ).val() );
                } );


            }

            function searchPlace( map, address ) {
                for ( var i = 0; i < list.length; i++ ) {
                    var data = list[i];
                    var name = data.name;
                    if ( name.trim().includes( address.trim() ) != 0 || address.trim().includes( name.trim() ) != 0 ) {
                        infowindows_hash[data.docId].open( map, markers_hash[data.docId] )
                        fillData( data, data.docId );
                    }
                }
            }

            function searchAddressToCoordinate( map, address ) {
                naver.maps.Service.geocode( {
                    query: address
                }, function ( status, response ) {
                    var infoWindow = new naver.maps.InfoWindow( {
                        anchorSkew: true
                    } );
                    if ( status === naver.maps.Service.Status.ERROR ) {
                        return alert( 'Something Wrong!' );
                    }

                    if ( response.v2.meta.totalCount === 0 ) {
                        return alert( '검색 결과가 없습니다.' );
                    }

                    var htmlAddresses = [],
                        item = response.v2.addresses[0],
                        point = new naver.maps.Point( item.x, item.y );

                    if ( item.roadAddress ) {
                        htmlAddresses.push( '[도로명 주소] ' + item.roadAddress );
                    }

                    if ( item.jibunAddress ) {
                        htmlAddresses.push( '[지번 주소] ' + item.jibunAddress );
                    }

                    if ( item.englishAddress ) {
                        htmlAddresses.push( '[영문명 주소] ' + item.englishAddress );
                    }

                    infoWindow.setContent( [
                        '<div style="padding:10px;min-width:200px;line-height:150%;">',
                        '<h4 style="margin-top:5px;">검색 주소 : ' + address + '</h4><br />',
                        htmlAddresses.join( '<br />' ),
                        '</div>'
                    ].join( '\n' ) );

                    map.setCenter( point );
                    console.log( "item :", item.x, item.y );
                    $( "#latitude" ).val( item.y );
                    $( "#longitude" ).val( item.x );
                    $( "#delete" ).hide();
                    addTempNaverMarker( item.y, item.x, map );
                    infoWindow.open( map, point );
                    infowindows.push( infoWindow );
                } );
            }

            // init auth
            function initAuth( firebase, db ) {
                $( document ).ready( function () {
                    var firebaseEmailAuth = firebase.auth();
                    firebaseEmailAuth.onAuthStateChanged( function ( user ) {

                        if ( user ) {
                            var user = firebase.auth().currentUser;
                            var name, email, photoUrl, uid, emailVerified;
                            if ( user != null ) {
                                name = user.displayName;
                                email = user.email;
                                photoUrl = user.photoURL;
                                emailVerified = user.emailVerified;
                                uid = user.uid;
                                console.log( "login", email );

                                db.collection( "account" ).get().then( ( querySnapshot ) => {
                                    querySnapshot.forEach( ( doc ) => {
                                        var data = doc.data();
                                        var array = data.id;
                                        var checked = false;
                                        for ( var i = 0; i < array.length; i++ ) {
                                            console.log( "id : " + array[i] );
                                            if ( array[i] == email ) {
                                                checked = true;
                                            }
                                        }
                                        console.log( "checked : " + checked );
                                        if ( !checked ) {
                                            console.log( "no permission" );
                                            //TODO
                                            $( '#dialog_permission' ).modal( "show" );

                                            $( '#permission_ok' ).on( "click", function ( e ) {
                                                firebase.auth().signOut().then( function () {
                                                    console.log( "logout success" );
                                                    location.href = "https://nodisable.firebaseapp.com/";
                                                } ).catch( function ( error ) {
                                                    console.error( error );
                                                } );
                                            } );
                                        } else {
                                            $( '#login_id' ).text( user.email );
                                        }
                                    } );
                                } );


                            }


                        } else {
                            location.href = "https://nodisable.firebaseapp.com/";
                        }
                    } );

                } );
            }

            // init firestore
            function initData( firebase, db, map, category1, category2 ) {
                console.log( "initData" );
                var index=0;
                for(index=0;index<markers.length;index++){
                    markers[index].setMap(null);
                }
                markers = [];
                list = [];
                db.collection( "location" ).get().then( ( querySnapshot ) => {
                    markers = [];
                    querySnapshot.forEach( ( doc ) => {
                        var data = doc.data();
                        data.docId = doc.id;
                        //console.log("category1 : " + category1 + " , category2 : " + category2 + " , data category1 : " + data.category1 + " , data category2 : " + data.category2);
                        if ( category1.trim().localeCompare( "전체" ) == 0 ) {
                            //addMarker(data, doc.id);
                            
                            addNaverMarker( data, doc.id, map );
                            $( '#subCategory' ).text( category2);
                            $( '#count' ).text(" "+markers.length + "개" );
                        } else {
                            if ( category1.trim().includes( data.category1.trim() ) != 0 ) {
                                if ( category2.trim().includes( data.category2.trim() ) != 0 || category2.trim().localeCompare( "전체" ) == 0 ) {
                                    //addMarker(data, doc.id);
                                    
                                    addNaverMarker( data, doc.id, map );
                                    $( '#subCategory' ).text( category2);
                                    $( '#count' ).text(" "+markers.length + "개" );
                                }
                            }
                        }
                    } );
                } );
                $( '#subCategory' ).text( category2);
                $( '#count' ).text(" "+markers.length + "개" );
               
                map.setZoom( 16 );
            }

            // add naver marker
            function addNaverMarker( data, docId, map ) {
                console.log("addNaverMarker docId : "+docId+" , data : "+data.name);
                if ( typeof data.latitude != "number" || typeof data.longitude != "number" ) {
                    //console.log("addMarker lat or lon is invalid");
                    return;
                }

                var iconPath;
                if ( !data.using ) {
                    iconPath = "http://maps.google.com/mapfiles/ms/micons/red.png";
                } else {
                    iconPath = "http://maps.google.com/mapfiles/ms/micons/blue.png";
                }
                var markerOptions = {
                    position: new naver.maps.LatLng( data.latitude, data.longitude ),
                    map: map,
                    icon: {
                        url: iconPath,
                        size: new naver.maps.Size( 50, 52 ),
                        origin: new naver.maps.Point( 0, 0 ),
                        anchor: new naver.maps.Point( 25, 26 )
                    }
                };


                var marker = new naver.maps.Marker( markerOptions );
                var title = ["<h3>" + data.name + "</h3>", "<div>" + data.address + "</div>"].join( '' );

                var infowindow = new naver.maps.InfoWindow( {
                    content: title
                } );

                naver.maps.Event.addListener( marker, "click", function ( e ) {
                    if ( infowindow.getMap() ) {
                        infowindow.close();
                    } else {
                        console.log( "docId : " + docId )
                        infowindow.open( map, marker );
                        fillData( data, docId );
                    }
                } );

                markers.push( marker );
                markers_hash[docId] = marker;
                infowindows.push( infowindow );
                infowindows_hash[docId] = infowindow;
                list.push( data );
            }

            // add marker
            function addMarker( data, docId ) {
                //console.log("addMarker docid :" + docId);
                if ( typeof data.latitude != "number" || typeof data.longitude != "number" ) {
                    //console.log("addMarker lat or lon is invalid");
                    return;
                }
                var pos = {
                    lat: data.latitude,
                    lng: data.longitude
                };
                var marker = new google.maps.Marker( {
                    position: pos,
                    map: map,
                    label: data.name
                } );

                if ( !data.using ) {
                    marker.setIcon( "http://maps.google.com/mapfiles/ms/micons/blue.png" );
                }
                const infowindow = new google.maps.InfoWindow( {
                    content: data.name + "<br>" + docId,

                } );
                marker.addListener( "click", () => {
                    infowindow.open( map, marker );
                    fillData( data, docId );
                } );
                markers.push( marker );

            }

            function fillData( data, docId ) {
                $( "#submit" ).val( docId );
                $( "#submit" ).text( "수정" );
                $( "#delete" ).show();

                $( "#data_category1" ).val( data.category1 );
                $( "#data_category2" ).val( data.category2 );

                $( '#input_category1' ).val( data.category1 );
                $( '#input_category2' ).val( data.category2 );

                $( '#latitude' ).val( data.latitude );
                $( '#longitude' ).val( data.longitude );
                $( '#name' ).val( data.name );
                $( '#contact' ).val( data.contact );
                $( '#address' ).val( data.address );
                $( '#summary' ).val( data.summary );
                $( '#input_floor' ).val( data.floor );
                $( '#input_using' ).val( data.using );


                // $("#image1").val("");
                // $("#image1_reset").val("");
                // $("#image1_preview").attr('src', data.image.base);
                $( "#image2" ).val( "" );
                $( "#image2_reset" ).val( "" );

                if (data.image !== undefined || data.image.gyungsaro !== undefined) {
                    $( "#image2_preview" ).attr( 'src', data.image.gyungsaro );
                }
                
                $( "#image3" ).val( "" );
                $( "#image3_reset" ).val( "" );
                if (data.image !== undefined || data.image.parking !== undefined) {
                    $( "#image3_preview" ).attr( 'src', data.image.parking );
                }
               
                $( "#image4" ).val( "" );
                $( "#image4_reset" ).val( "" );

                if (data.image !== undefined || data.image.restroom !== undefined) {
                    $( "#image4_preview" ).attr( 'src', data.image.restroom );
                }
                
                $( "#image5" ).val( "" );
                $( "#image5_reset" ).val( "" );
                if (data.image !== undefined || data.image.elevator !== undefined) {
                    $( "#image5_preview" ).attr( 'src', data.image.elevator );
                }
                
            }

            
            function initInputDropDown(firebase,db){
                console.log( "initInputDropDown" );
                db.collection("category").doc("category").get().then( function ( doc ) {
                    var script = "";
                    console.log( doc.id, " => ", doc.data() );
                    var data = doc.data();
                    var fields = Object.keys( data );
                    console.log( fields );
                    var index;
                    var _index = 1;
                    for ( index = 0; index < fields.length; index++ ) {
                        var cate1 = fields[index];
                        if(cate1 == "카테고리"){
                            continue;
                        }
                        var c = "data_category"+_index;
                        var s = "data_submenu"+_index;
                        dataCategoryArr.push([c,s]);
                        script="<li class='dropdown-submenu'>";
                        script+= "<a id='"+c+"'";
                        script+= " tabindex='-1' href='#'>";
                        script+= cate1;
                        script+="<span class='caret'></span></a>";
                        script+=" <ul id='"+s+"' class='dropdown-menu'>";
                        var key = fields[index];
                        var subData = data[key];
                        var jndex = 0;
                        
                        for ( jndex = 0; jndex < subData.length; jndex++ ) {
                            console.log( "-", subData[jndex] );
                            var value = subData[jndex];
                            script+="<li><a tabindex='-1' href='#'>"+value+"</a></li>";
                            
                        }
                        script+="</ul>";
                        script+="</li>";
                        
                        $( '#category_dropdown_data' ).append(script);
                        _index++;

                    }
                    initDropdownEvent(firebase,db);
                } ).catch( function ( error ) {
                    console.log( error );
                } );
            }

            function initDropdown(firebase,db ) {
                console.log( "initDropdown" );
                db.collection( "category" ).doc( "category" ).get().then( function ( doc ) {
                    var script = "<li class='dropdown-submenu'><a id='category_all' tabindex='-1' href='#''>전체 <span class='caret'></span></a></li>";
                    $( '#category_dropdown' ).append(script);
                    console.log( doc.id, " => ", doc.data() );
                    var data = doc.data();
                    var fields = Object.keys( data );
                    console.log( fields );
                    var index;
                    var _index = 1;
                    for ( index = 0; index < fields.length; index++ ) {
                        var cate1 = fields[index];
                        if(cate1 == "카테고리"){
                            continue;
                        }
                        var c = "category"+_index;
                        var s = "submenu"+_index;
                        categoryArr.push([c,s]);
                        script="<li class='dropdown-submenu'>";
                        script+= "<a id='"+c+"'";
                        script+= " tabindex='-1' href='#'>";
                        script+= cate1;
                        script+="<span class='caret'></span></a>";
                        script+=" <ul id='"+s+"' class='dropdown-menu'>";
                        var key = fields[index];
                        var subData = data[key];
                        var jndex = 0;
                        
                        for ( jndex = 0; jndex < subData.length; jndex++ ) {
                            console.log( "-", subData[jndex] );
                            var value = subData[jndex];
                            script+="<li><a tabindex='-1' href='#'>"+value+"</a></li>";
                            
                        }
                        
                        script+="<li>";
                        script+="<button id='";
                        script+="add_"+s;
                        script+="' type='button' class='btn btn-light' data-toggle='modal' data-target='#subCategoryModal'>추가</button>";
                        script+="<button id='";
                        script+="delete_"+s;
                        script+="' type='button' class='btn btn-light' data-toggle='modal' data-target='#deleteCategoryModal'>삭제</button>";
                        script+="</li>";
                        script+="</ul>";
                        script+="</li>";
                        console.log("script",script);
                        $( '#category_dropdown' ).append(script);
                        _index++;
                    }
                    // add
                    script="<li class='dropdown-submenu'>";
                    script+="<button type='button' class='btn btn-light' data-toggle='modal' data-target='#categoryModal' style=''>추가</button>";
                    script+="</li>";
                    $('#category_dropdown').append( script);
                    initDropdownEvent(firebase,db);
                } ).catch( function ( error ) {
                    console.log( error );
                } );

                $('#category_delete_btn').hide();
                $('#sub_category_delete_btn').hide();

            }
            var categoryArr = [];
            var dataCategoryArr = [];
            var currentSubmenu="";
            var currentCategoryText="";
            var currentCategoryText2="";
            function initDropdownEvent(firebase,db) {
                console.log( "initDropdownEvent" );
                // top & input
                $( document ).ready( function () {
                  
                    $( '#category_all' ).on( "click", function ( e ) {
                        $('#category_delete_btn').hide();
                        $('#sub_category_delete_btn').hide();
                        updateList( "", "전체", "전체" );

                    } );

                    // initDropdown

                    var index = 0;
                    for(index=0;index<categoryArr.length;index++){
                        initSeletCategoryDropdown( categoryArr, categoryArr[index][0], categoryArr[index][1] );
                    }
                    
                    $("#category_add_btn").click(function () {
                        var value = $("#category_add_text").val();
                        console.log("category_add click "+value);
                        $( "#category_add_text" ).val( "" );
                        addCategoryData( firebase, value );
                        
                    });

                    $("#subCategory_add_btn").click(function () {
                        var category1 = currentCategoryText;
                        var category2 = $("#subCategory_add_text").val();
                        console.log("subCategory_add click category1 : "+category1+" , category2 : "+category2);
                        $("#subCategory_add_text" ).val("");
                       addSubCategoryData(firebase,category1,category2);
                       

                    });

                    $("#category_delete_ok_btn").click(function () {
                        var value = currentCategoryText;
                        console.log("category_delete click "+value);
                        $( "#category_delete_text" ).val( "" );
                        deleteCategoryData( firebase, value );
                    

                    });

                    $("#sub_category_delete_ok_btn").click(function () {
                        var c = currentCategoryText;
                        var value = currentCategoryText2;
                        console.log("sub_category_delete click "+value);
                        $( "#category_delete_text" ).val( "" );
                        deleteSubCategoryData( firebase, c,value );
                    
                    });

                   

                    for(index=0;index<dataCategoryArr.length;index++){
                        initSeletCategoryDropdown( dataCategoryArr, dataCategoryArr[index][0], dataCategoryArr[index][1] );
                    }
                    
                    function initSeletCategoryDropdown( arr, category, submenu ) {
                        console.log("initSeletCategoryDropdown arr : "+arr+" , category : "+category+" , submenu : "+submenu);
                        $( "#" + category ).off().on( "click", function ( e ) {
                            console.log("initSeletCategoryDropdown onClick "+category+" , submenu : "+submenu);
                            for ( var i = 0; i < arr.length; i++ ) {

                                if ( arr[i][0] == category ) {

                                    $( "#" + arr[i][0] ).next( 'ul' ).toggle();
                                } else {

                                    $( "#" + arr[i][0] ).next( 'ul' ).hide();
                                }
                            }
                            e.stopPropagation();
                            e.preventDefault();
                            var category1 = e.target.textContent;
                            $( "#" + submenu ).off().on( "click", function ( e ) {
                                console.log( "submenu click : " + submenu );
                                currentSubmenu = submenu;
                                var category2 = e.target.textContent;
                                currentCategoryText2 = category2;
                                if(category2==="추가"){
                                    $("#subCategoryModal").modal();
                                } else if(category2=="삭제"){
                                    $("#deleteCategoryModal").modal();
                                    currentCategoryText = category1;
                                    $( '#category_delete_text' ).text( category1 + "을(를) 삭제하시겠습니까?" );
                                } else {
                                    updateList( category, category1, category2 );
                                }

                                var c = $( '#category' ).text();
                                if ( c != "전체" ) {
                                    $('#category_delete_btn').show();
                                    $('#sub_category_delete_btn').show();
                                } else {
                                    $('#category_delete_btn').hide();
                                    $('#sub_category_delete_btn').hide();
                                }
                                
                                $( "#" + submenu ).hide();
                                e.stopPropagation();
                                e.preventDefault();
                                
                            } );
                        } );
                    }

                    // init add sub category
                    $('#subCategoryModal').on('show.bs.modal', function (event) {
                        if(currentSubmenu===""){
                            return;
                        }
                        
                        var modal = $(this);
                        
                        var parentCategory = categoryArr[Number(currentSubmenu.replace("submenu",""))-1];
                        currentCategoryText = $("#"+parentCategory[0]).text();

                        console.log("subCategoryModal on current category : "+currentSubmenu+" , parentCategory : "+parentCategory);
                        modal.find('.modal-title').text(currentCategoryText);
                    })

                    // init delete category
                    $('#deleteCategoryModal').on('show.bs.modal', function (event) {
                        
                        var modal = $( this );
                        var category = $('#category').text();
                        currentCategoryText = category;
                        console.log("deleteCategoryModal on "+category);
                        $( '#category_delete_text' ).text( category + "을(를) 삭제하시겠습니까?" );
                        
                    } )

                    // init delete sub category
                    $('#deleteSubCategoryModal').on('show.bs.modal', function (event) {
                        var modal = $( this );
                        var category = currentCategoryText;
                        console.log("deleteSubCategoryModal on "+category);
                        var parentCategory = categoryArr[Number(currentSubmenu.replace("submenu",""))-1];
                        currentCategoryText = $("#"+parentCategory[0]).text();
                        $( '#sub_category_delete_text' ).text( currentCategoryText2 + "을(를) 삭제하시겠습니까?" );
                        
                    } )

                    initFloorDropdown();
                    initUsingDropdown();

                    function initFloorDropdown() {
                        $( "#floor" ).prop( "click", null );
                        $( "#floor" ).on( "click", function ( e ) {

                            e.stopPropagation();
                            e.preventDefault();
                            $( "#input_floor" ).val( e.target.textContent );
                        } );
                    }

                    function initUsingDropdown() {
                        $( "#using" ).prop( "click", null );
                        $( "#using" ).on( "click", function ( e ) {

                            e.stopPropagation();
                            e.preventDefault();
                            $( "#input_using" ).val( e.target.textContent );
                        } );
                    }

                    // initImage
                    $( function () {
                        //initPreview("image1", "image1_preview", "image1_reset");
                        initPreview( "image2", "image2_preview", "image2_reset" );
                        initPreview( "image3", "image3_preview", "image3_reset" );
                        initPreview( "image4", "image4_preview", "image4_reset" );
                        initPreview( "image5", "image5_preview", "image5_reset" );
                    } );

                    function initPreview( image, preview, reset ) {

                        $( "#" + image ).prop( "change", null );
                        $( "#" + image ).on( "change", function () {
                            showPreview( this, preview );
                        } );
                        $( "#" + reset ).on( "click", function ( e ) {
                            $( "#" + image ).val( "" );
                            $( "#" + preview ).attr( 'src', "" );
                        } );
                    }

                    function showPreview( input, preview ) {

                        if ( input.files && input.files[0] ) {
                            var reader = new FileReader();

                            reader.onload = function ( e ) {
                                $( "#" + preview ).attr( 'src', e.target.result );
                            }
                            reader.readAsDataURL( input.files[0] );
                        }
                    }

                } );
            }

            function updateList( category, category1, category2 ) {
                console.log("updateList category : " + category + " , category1 : " + category1 + " , category2 : " + category2);
                var res = category.indexOf( "data_" );

                if ( category.indexOf( "data_" ) == -1 ) {
                    
                    $( '#category' ).text( category1 );

                    for ( var i = 0; i < markers.length; i++ ) {
                        markers[i].setMap( null );
                        infowindows[i].close();
                    }

                    initData( firebase, db, map, category1, category2 );
                } else {

                    $( '#input_category1' ).val( category1 );
                    $( '#input_category2' ).val( category2 );
                }

            };

            function LocationData(
                category1,
                category2,
                name,
                contact,
                latitude,
                longitude,
                summary,
                using,
                floor,
                address,
                image1,
                image2,
                image3,
                image4,
                image5,
            ) {
                this.category1 = category1;
                this.category2 = category2;
                this.name = name;
                this.contact = contact;
                this.latitude = latitude;
                this.longitude = longitude;
                this.summary = summary;
                this.using = using;
                this.floor = floor;
                this.address = address;
                this.image1 = image1;
                this.image2 = image2;
                this.image3 = image3;
                this.image4 = image4;
                this.image5 = image5;
            }
            $( document ).ready( function () {

                $( "#submit" ).on( "click", function ( e ) {

                    var category1 = $( '#input_category1' ).val();
                    var category2 = $( '#input_category2' ).val();
                    var name = $( '#name' ).val();
                    var latitude = Number( $( '#latitude' ).val() );
                    var longitude = Number( $( '#longitude' ).val() );

                    //console.log("category1:" + category1 + ",category2:" + category2 + ",name:" + name + ",latitude:" + latitude + ",longitude:" + longitude);
                    //console.log("category1:" + isNaN(category1) + ",category2:" + isNaN(category2) + ",name:" + isNaN(name) + ",latitude:" + isNaN(latitude) + ",longitude:" + isNaN(longitude));
                    if ( category1 == "" || category2 == "" || name == "" || latitude == "" || longitude == "" ) {
                        $( "#dialog_error" ).modal( "show" );
                    } else if ( isNaN( latitude ) || isNaN( longitude ) ) {
                        $( "#dialog_error" ).modal( "show" );
                    } else {
                        $( "#dialog_submit" ).modal( "show" );
                    }
                } );

                $( "#map_refresh" ).on( "click", function ( e ) {
                    updateList( "", "전체", "전체" );
                } );

                $( "#delete" ).hide();

                $( "#reset" ).on( "click", function ( e ) {
                    resetAll();
                } );


                function resetAll() {
                    console.log( "resetAll" );
                    $( "#submit" ).val( "" );
                    $( "#submit" ).text( "추가" );
                    $( "#data_category1" ).val( "" );
                    $( "#data_category2" ).val( "" );

                    $( '#input_category1' ).val( "" );
                    $( '#input_category2' ).val( "" );

                    $( '#latitude' ).val( "" );
                    $( '#longitude' ).val( "" );
                    $( '#name' ).val( "" );
                    $( '#contact' ).val( "" );
                    $( '#address' ).val( "" );
                    $( '#summary' ).val( "" );
                    $( '#input_floor' ).val( "" );
                    $( '#input_using' ).val( "" );


                    $( "#image1" ).val( "" );
                    $( "#image1_reset" ).val( "" );
                    $( "#image1_preview" ).attr( 'src', "" );
                    $( "#image2" ).val( "" );
                    $( "#image2_reset" ).val( "" );
                    $( "#image2_preview" ).attr( 'src', "" );
                    $( "#image3" ).val( "" );
                    $( "#image3_reset" ).val( "" );
                    $( "#image3_preview" ).attr( 'src', "" );
                    $( "#image4" ).val( "" );
                    $( "#image4_reset" ).val( "" );
                    $( "#image4_preview" ).attr( 'src', "" );
                    $( "#image5" ).val( "" );
                    $( "#image5_reset" ).val( "" );
                    $( "#image5_preview" ).attr( 'src', "" );


                }

                $( "#delete_cancel" ).on( "click", function ( e ) {
                    $( '#dialog_delete' ).hide();
                } );
                $( "#delete_ok" ).on( "click", function ( e ) {
                    console.log( "delete" );
                    var current_docu = $( "#submit" ).val();
                    console.log( "submit current_docu : " + current_docu );

                    db.collection( "location" ).doc( current_docu ).delete().then( function () {
                        console.log( "delete success" );
                        updateList( "", "전체", "전체" );
                        location.reload(true);
                    } ).catch( function ( error ) {
                        console.error( error );
                    } );

                } );

                $( "#submit_cancel" ).on( "click", function ( e ) {
                    $( '#dialog_submit' ).hide();
                } );

                $( "#submit_ok" ).on( "click", function ( e ) {
                    console.log( "submit" );

                    var current_docu = $( "#submit" ).val();
                    console.log( "submit current_docu : " + current_docu );

                    var category1 = $( 'input#input_category1' ).val();
                    var category2 = $( 'input#input_category2' ).val();
                    var name = $( 'input#name' ).val();
                    var contact = $( 'input#contact' ).val();
                    var latitude = $( 'input#latitude' ).val();
                    var longitude = $( 'input#longitude' ).val();
                    var summary = $( 'input#summary' ).val();
                    var using = $( '#input_using' ).val();
                    var floor = $( '#input_floor' ).val();
                    var address = $( 'input#address' ).val();
                    var image1 = $( 'input#image1' ).val();
                    var image2 = $( 'input#image2' ).val();
                    var image3 = $( 'input#image3' ).val();
                    var image4 = $( 'input#image4' ).val();
                    var image5 = $( 'input#image5' ).val();
                    var data = new LocationData(
                        category1,
                        category2,
                        name,
                        contact,
                        latitude,
                        longitude,
                        summary,
                        using,
                        floor,
                        address,
                        image1,
                        image2,
                        image3,
                        image4,
                        image5,
                    );
                    requestUpdateData( data, current_docu );
                } );
            } );

            async function requestUploadFile( docu, id,field_name ) {

                var storageRef = firebase.storage().ref();

                var files = $( "#" + id ).prop( "files" );
                var fileName = $( "#" + id ).val();
                var clean = fileName.split( '\\' ).pop();
                var preview = $( "#" + id + "_preview" ).attr( 'src' );
                //중복 체크
                
                var current_file = storageRef.child('images/'+clean);
                console.log("current file : "+current_file.fullPath);
                var old_url = "";
                if(current_file.fullPath.indexOf('.png') > 0){
                    //old_url = await current_file.getDownloadURL();
                    current_file.getDownloadURL().then(function(url){
                        old_url = url;
                    }).catch(function(error){
                        console.log(error);
                    });
                    setTimeout(() => console.log("sleep for old image check"), 1000)
                }
                console.log("requestUploadFile fileName : "+fileName+" , field_name : "+field_name+" , clean : "+clean+" , old_url: "+old_url);
                /*
                current_file.getDownloadURL().then(function(url){
                    console.log("old_url: "+old_url);
                    old_url = url;
                }).catch(function(error){
                    console.log(error);
                });
                */
                // var old_file_url= await current_file.getDownloadURL();
                // console.log("current file : "+current_file.fullPath+" , url : "+old_file_url);
                
                if ( clean.trim() == "" && preview.trim() != "" ) {
                    uploadCount++;
                    console.log( "requestUploadFile empty return" );
                    if ( uploadCount == UPLOAD_MAX_COUNT ) {
                        requestComplete();
                        uploadCount = 0;
                    }
                    return;
                }

                if ( preview.trim() == "" ) {
                    updateImage( id, "", docu );
                    return;
                }

                await storageRef.child( "images/" + clean )
                    .put( files[0] ).then( ( snapshot ) => {
                        snapshot.ref.getDownloadURL().then( async url => {
                            updateOldImage(id,old_url,url,field_name);
                            updateImage( id, url, docu );
                        } )
                    } ).catch( ( error ) => {
                        console.error( error );
                    } );
            }

            async function updateOldImage( id, old_url, url,field_name ) {
                console.log("updateOldImage old_url :"+old_url+" , new url: "+url);
                if(old_url===""){
                    return;
                }
                let tmp = db.collection("locationImage").where(field_name,'==',old_url);
                tmp.get().then((querySnapshot)=>{
                    querySnapshot.forEach((doc)=>{
                        console.log("doc id :"+doc+","+doc.data());
                        db.collection("location").doc(doc).update({
                            field_name:url
                        });
                    });
                });

            }

            async function updateImage( id, url, docu ) {
                console.log("updateImage id:"+id+",url:"+url+",docu:"+docu);
                var value;
                var key;
                let valueMap
                switch ( id ) {
                    // case "image1":
                    //     valueMap = {
                    //         "image.base": url
                    //     }
                    //     break;
                    case "image2":
                        valueMap = {
                            "image.gyungsaro": url
                        }
                        break;
                    case "image3":
                        valueMap = {
                            "image.parking": url
                        }
                        break;
                    case "image4":
                        valueMap = {
                            "image.restroom": url
                        }
                        break;
                    case "image5":
                        valueMap = {
                            "image.elevator": url
                        }
                        break;

                }

                await db.collection( "location" ).doc( docu ).update( valueMap ).then( function () {
                    uploadCount++;
                    console.log( docu + " , " + id + " upload success uploadCount : " + uploadCount );
                    if ( uploadCount == UPLOAD_MAX_COUNT ) {
                        requestComplete();
                        uploadCount = 0;
                    }

                } ).catch( function ( error ) {
                    console.log( error );
                } );
            }

            function addSubCategoryData(firebase,category1,category2){
                console.log("addSubCategoryData category1 : "+category1+" ,category2 :"+category2);
                if(category2===''){
                    return;    
                }

                var map ={};
                map[category1] = firebase.firestore.FieldValue.arrayUnion(category2)
                console.log("map[category] : "+map[category1]);
                db.collection("category").doc("category").update(map).then(()=>{
                            location.reload(true);
                        });
                
            }

            function deleteCategoryData(firebase,category){
                console.log("deleteCategoryData category :"+category);
                if(category===''){
                    return;    
                }
                var map ={};
                map[category] = firebase.firestore.FieldValue.delete();
                db.collection("category").doc("category").update(map);
                map["카테고리"] = firebase.firestore.FieldValue.arrayRemove(category);
                db.collection("category").doc("category").update(map).then(()=>{
                            location.reload(true);
                        });
                
            }

            function deleteSubCategoryData(firebase,category,category2){
                console.log("deleteSubCategoryData category :"+category+" , category2 : "+category2);
                if(category===''){
                    return;    
                }
                var map ={};
                map[category] = firebase.firestore.FieldValue.arrayRemove(category2);
                db.collection("category").doc("category").update(map).then(()=>{
                            location.reload(true);
                        });
                
            }

            function addCategoryData(firebase,category){
                console.log("addCategoryData category :"+category);
                if(category===''){
                    return;    
                }
                
                var map ={};
                map[category] = [category];
                console.log("map[category] : "+map[category]);
                db.collection("category").doc("category").get().then(function (doc){
                    var data = doc.data();
                    var fields = Object.keys( data );
                    var index;
                    var isExist = false;
                    for ( index = 0; index < fields.length; index++ ) {
                        console.log("category : "+ category+", fields : "+fields[index])    
                        if ( category === fields[index] ) {
                            isExist = true;
                            break;
                        }
                    }
                     
                    console.log( "category : " + category + ", isExist : " + isExist )
                    if ( !isExist ) {
                        db.collection( "category" ).doc( "category" ).set( map, { merge: true } );
                        db.collection( "category" ).doc( "category" ).update( {
                            "카테고리": firebase.firestore.FieldValue.arrayUnion( category )
                        } ).then(()=>{
                            location.reload(true);
                        });
                    }
                    
                    
                });
                
                
            }

            function requestComplete() {
                console.log( "requestComplete" );
                $( "#dialog_complete" ).modal( "show" );
                $( "#complete_ok" ).on( "click", function ( e ) {
                    updateList( "", "전체", "전체" );
                } );
            }


            var uploadCount = 0;
            var UPLOAD_MAX_COUNT = 4;

            function requestUpdateData( data, current_docu ) {
                var docu = current_docu.toString();
                var isUpdate = true;
                if ( current_docu == null || current_docu.trim() == "" ) {
                    isUpdate = false;
                    docu = new Date().getTime().toString();;
                }
                console.log( "requestUpdateData docu : " + docu + " , current_docu : " + current_docu );

                var category1 = data.category1;
                data.latitude *= 1;
                data.longitude *= 1;

                if ( isUpdate ) {
                    db.collection( "location" ).doc( docu ).update( {
                        category1: data.category1,
                        category2: data.category2,
                        name: data.name,
                        summary: data.summary,
                        contact: data.contact,
                        latitude: data.latitude,
                        longitude: data.longitude,
                        address: data.address,
                        // image: {
                        //     base: "",
                        //     parking: "",
                        //     gyungsaro: "",
                        //     restroom: "",
                        //     elevator: ""
                        // },
                        using: true,
                        floor: data.floor
                    } ).then( function () {
                        console.log( "firestore update success" );
                        // requestUploadFile(docu, "image1");
                        // console.log("req1 end");
                        requestUploadFile( docu, "image2","data.image.gyungsaro");
                        console.log( "req2 end" );
                        requestUploadFile( docu, "image3","data.image.parking");
                        console.log( "req3 end" );
                        requestUploadFile( docu, "image4","data.image.restroom");
                        console.log( "req4 end" );
                        requestUploadFile( docu, "image5","data.image.elevator");
                        console.log( "req5 end" );
                        resetAll();
                    } ).catch( function ( error ) {
                        console.log( error );
                    } );
                } else {
                    db.collection( "location" ).doc( docu ).set( {
                        category1: data.category1,
                        category2: data.category2,
                        name: data.name,
                        contact: data.contact,
                        latitude: data.latitude,
                        longitude: data.longitude,
                        address: data.address,
                        using: true,
                        floor: data.floor
                    } ).then( function () {
                        console.log( "firestore input success" );
                        // requestUploadFile(docu, "image1");
                        // console.log("req1 end");
                        requestUploadFile( docu, "image2","data.image.gyungsaro");
                        console.log( "req2 end" );
                        requestUploadFile( docu, "image3","data.image.parking");
                        console.log( "req3 end" );
                        requestUploadFile( docu, "image4","data.image.restroom");
                        console.log( "req4 end" );
                        requestUploadFile( docu, "image5","data.image.elevator");
                        console.log( "req5 end" );
                        resetAll();
                    } ).catch( function ( error ) {
                        console.log( error );
                    } );
                }
            }

        </script>

    </div>


    <div class="tab-pane fade" id="noticeContent">
        <h1 id="title">공지사항</h1>
        <div class="container">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <div class="text-right mt-3">
                            <button id="notice_submit" type="button" class="btn btn-success" data-toggle="modal"
                                href="#dialog_notice">추가</button>
                            <br>
                            <br>
                        </div>
                        <tbody id="tbody">
                            <tr>
                                <td>번호</td>
                                <td>제목</td>
                                <td>시간</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>

        </div>
        <!-- notice add dialog-->
        <div class="modal fade" id="dialog_notice" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p>공지사항</p>
                    </div>
                    <div class="modal-body">
                        <p>제목</p>
                        <input id="notice_title" type="text" name="name" class="form-control" maxlength="50" value="">
                        <p>내용</p>
                        <input id="notice_content" type="text" name="name" class="form-control" value="">
                        <br>
                        <p>이미지</p>
                        <button id="notice_content_image_reset">초기화</button>
                        <input type="file" id="notice_content_image" value="" />
                        <img id="notice_content_image_preview" src="">
                    </div>
                    <div class="modal-footer">
                        <button id="notice_ok" type="button" class="btn btn-success" data-dismiss="modal">확인</button>
                        <button id="notice_cancel" type="button" class="btn btn-warning"
                            data-dismiss="modal">취소</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- notice detail dialog-->
        <div class="modal fade" id="dialog_notice_detail" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p id="notice_dialog_title">제목</p>
                    </div>
                    <div class="modal-body">
                        <p id="notice_dialog_content">내용</p>
                        <img id="notice_dialog_image" src="">
                        <p id="notice_dialog_time">시간</p>
                    </div>
                    <div class="modal-footer">
                        <button id="notice_dialog_ok" type="button" class="btn btn-success"
                            data-dismiss="modal">확인</button>
                        <button id="notice_dialog_delete" type="button" class="btn btn-warning"
                            data-dismiss="modal">삭제</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- notice detail confirm dialog-->
        <div class="modal fade" id="dialog_notice_delete" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <p id="dialog_notice_delete_title">공지사항 삭제</p>
                    </div>
                    <div class="modal-body">
                        <p id="dialog_notice_delete_content">내용을 삭제하시겠습니까? (복구 불가)</p>
                    </div>
                    <div class="modal-footer">
                        <button id="dialog_notice_delete_ok" type="button" class="btn btn-success"
                            data-dismiss="modal">예</button>
                        <button id="dialog_notice_delete_delete" type="button" class="btn btn-warning"
                            data-dismiss="modal">아니오</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var db;
        $( document ).ready( function () {

            initFirebase();

            function initFirebase() {
                db = firebase.firestore();
                initNoticeList( db );

            }


            function initNoticeList( db ) {
                console.log( "initNoticeList" );
                $( "#tbody" ).empty();
                var head = "";
                head += "<tr>";
                head += "<td>번호</td>";
                head += "<td>제목</td>";
                head += "<td>시간</td>";
                head += "</tr>";
                $( "#tbody" ).append( head );
                db.collection( "notice" ).orderBy( "time", "desc" ).get().then( ( querySnapshot ) => {
                    querySnapshot.forEach( ( doc ) => {

                        updateNoticeList( doc.data(), doc.id );

                    } );
                } );


            }

            function updateNoticeList( data, id ) {
                console.log( "updateNoticeList id : " + id + " , time : " + data.time );
                var date = new Date( Number( data.time ) );
                console.log( "updateNoticeList date : " + date );
                var day = date.getDay();
                switch ( day ) {
                    case 0:
                        day = "일요일";
                        break;
                    case 1:
                        day = "월요일";
                        break;
                    case 2:
                        day = "화요일";
                        break;
                    case 3:
                        day = "수요일";
                        break;
                    case 4:
                        day = "목요일";
                        break;
                    case 5:
                        day = "금요일";
                        break;
                    case 6:
                        day = "토요일";
                        break;
                }
                var time = date.getFullYear() + "-" + ( date.getMonth() + 1 ) + "-" + date.getDate() + "-" + day + " " + date.getHours() + "시 " + date.getMinutes() + "분"
                var insertTr = "";
                console.log( "updateNoticeList time : " + time );

                insertTr += "<tr id=\'" + id + "'>";
                insertTr += "<td>" + id + "</td>";
                insertTr += "<td>" + data.title + "</td>";
                insertTr += "<td>" + time + "</td>";
                insertTr += "</tr>";

                $( "#tbody" ).append( insertTr );

                $( "#" + id ).on( "click", function ( e ) {
                    $( '#notice_dialog_title' ).text( data.title );
                    $( '#notice_dialog_content' ).text( data.content );
                    $( '#notice_dialog_time' ).val( data.time );
                    $( '#notice_dialog_time' ).text( time );
                    $( "#notice_dialog_image" ).attr( 'src', "" );
                    $( "#notice_dialog_image" ).attr( 'src', data.image );
                    $( '#dialog_notice_detail' ).modal( "show" );
                } );
            }

            $( "#dialog_notice" ).modal( "hide" );

            $( "#notice_ok" ).on( "click", function ( e ) {
                console.log( "add notice" );
                var docu = new Date().getTime().toString();
                var title = $( "#notice_title" ).val();
                var content = $( "#notice_content" ).val();
                var time = docu;
                console.log( "docu : " + docu + " , title : " + title + " , content : " + content + " , time : " + time );

                db.collection( "notice" ).doc( docu ).set( {
                    title: title,
                    content: content,
                    time: time
                } ).then( function () {
                    console.log( "firestore input success" );
                    $( "#notice_title" ).val( "" );
                    $( "#notice_content" ).val( "" );

                    requsetUploadNoticeFile( docu );
                } ).catch( function ( error ) {
                    console.log( error );
                } );
            } );

            $( "#notice_dialog_delete" ).on( "click", function ( e ) {
                $( '#dialog_notice_delete' ).modal( "show" );
            } );
            $( "#dialog_notice_delete_ok" ).on( "click", function ( e ) {
                var docu = $( '#notice_dialog_time' ).val();
                console.log( "notice delete : " + docu );
                db.collection( "notice" ).doc( docu ).delete().then( function () {
                    console.log( "notice delete success" );
                    initNoticeList( db );
                } ).catch( function ( error ) {
                    console.error( error );
                } );
            } );
            initNoticePreview();

            function requsetUploadNoticeFile( docu ) {
                var storageRef = firebase.storage().ref();

                var files = $( "#notice_content_image" ).prop( "files" );
                var fileName = $( "#notice_content_image" ).val();
                var clean = fileName.split( '\\' ).pop();
                console.log( "requsetUploadNoticeFile clean : " + clean + " , docu : " + docu );
                if ( clean.trim() == "" ) {
                    console.log( "requsetUploadNoticeFile empty return" );
                    initNoticeList( db );
                } else {
                    storageRef.child( "notice/" + clean )
                        .put( files[0] ).then( ( snapshot ) => {
                            snapshot.ref.getDownloadURL().then( url => {
                                db.collection( "notice" ).doc( docu ).update( {
                                    "image": url
                                } ).then( function () {
                                    console.log( "notice upload success uploadCount" );
                                    initNoticeList( db );

                                } ).catch( function ( error ) {
                                    console.log( error );
                                } );
                            } )
                        } ).catch( ( error ) => {
                            console.error( error );
                        } );
                }


            }

            function initNoticePreview() {
                $( "#notice_content_image" ).prop( "change", null );
                $( "#notice_content_image" ).on( "change", function () {
                    if ( this.files && this.files[0] ) {
                        var reader = new FileReader();

                        reader.onload = function ( e ) {
                            $( "#notice_content_image_preview" ).attr( 'src', e.target.result );
                        }
                        reader.readAsDataURL( this.files[0] );
                    }
                } );
                $( "#notice_content_image_reset" ).on( "click", function ( e ) {
                    $( "#notice_content_image" ).val( "" );
                    $( "#notice_content_image_preview" ).attr( 'src', "" );
                } );
            }
        } );
    </script>
    <div class="tab-pane fade" id="feedbackContent">
        <h1 id="title">의견</h1>
        <div class="container">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <button id="review_refresh" type="button" class="btn btn-success"
                            data-toggle="modal">업데이트</button>
                        <br>
                        <br>
                        <tbody id="tbody_review">
                            <tr>
                                <td>번호</td>
                                <td>제목</td>
                                <td>시간</td>
                            </tr>
                </div>

            </div>
        </div>
    </div>
    <script>
        var db;
        $( document ).ready( function () {
            initFirebase();

            function initFirebase() {
                db = firebase.firestore();
                initReviewList( db );
            }

            function initReviewList( db ) {
                console.log( "initReviewList" );
                $( "#tbody_review" ).empty();
                var head = "";
                head += "<tr>";
                head += "<td>번호</td>";
                head += "<td>내용</td>";
                head += "<td>시간</td>";
                head += "</tr>";
                $( "#tbody_review" ).append( head );
                db.collection( "comment" ).orderBy( "time", "desc" ).get().then( ( querySnapshot ) => {
                    querySnapshot.forEach( ( doc ) => {

                        updateCommentList( doc.data(), doc.id );

                    } );
                } );
            }

            function updateCommentList( data, id ) {
                var date = new Date( Number( data.time ) );
                var day = date.getDay();
                switch ( day ) {
                    case 0:
                        day = "일요일";
                        break;
                    case 1:
                        day = "월요일";
                        break;
                    case 2:
                        day = "화요일";
                        break;
                    case 3:
                        day = "수요일";
                        break;
                    case 4:
                        day = "목요일";
                        break;
                    case 5:
                        day = "금요일";
                        break;
                    case 6:
                        day = "토요일";
                        break;
                }
                var time = date.getFullYear() + "-" + ( date.getMonth() + 1 ) + "-" + date.getDate() + "-" + day + " " + date.getHours() + "시 " + date.getMinutes() + "분"
                var insertTr = "";
                console.log( "updateCommentList time : " + time );
                insertTr += "<tr id=\'" + id + "'>";
                insertTr += "<td>" + id + "</td>";
                insertTr += "<td>" + data.text + "</td>";
                insertTr += "<td>" + time + "</td>";
                insertTr += "</tr>";

                $( "#tbody_review" ).append( insertTr );
            }
            $( "#review_refresh" ).on( "click", function ( e ) {
                initReviewList( db );
            } );

        } );
    </script>


</body>

</html>